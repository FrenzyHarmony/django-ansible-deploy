---

- name: Create directory for ssh keys
  become_user: "{{ system_user }}"
  become: yes
  become_method: sudo
  file:
    name: "/home/{{ system_user }}/.ssh"
    owner: "{{ system_user }}"
    group: "{{ system_group }}"
    state: directory
  no_log: False
  tags: deploy

- name: check deployment private key exists
  become: no
  local_action: stat path="roles/deploy/files/secret.key"
  register: private_exists 
  tags: deploy

- name: copy deployment private key
  become_user: "{{ system_user }}"
  become: yes
  become_method: sudo
  copy:
    src: "secret.key"
    dest: "/home/{{ system_user }}/.ssh/id_rsa"
    owner: "{{ system_user }}"
    group: "{{ system_group }}"
    mode: 0600
  when: private_exists is defined and private_exists.stat.exists
  tags: deploy

- name: check deployment private key exists
  become: no
  local_action: stat path="roles/deploy/files/public.key"
  register: public_exists 
  tags: deploy

- name: copy deployment public key
  become_user: "{{ system_user }}"
  become: yes
  become_method: sudo
  copy:
    src: "public.key"
    dest: "/home/{{ system_user }}/.ssh/id_rsa.pub"
    owner: "{{ system_user }}"
    group: "{{ system_group }}"
    mode: 0600
  when: public_exists is defined and public_exists.stat.exists
  tags: deploy

- include: setup_git_repo.yml
  become_user: "{{ system_user }}"
  become: yes
  become_method: sudo
  tags: deploy

- name: Ensure that the virtualenv file permissions are set properly
  file: 
      path: "{{ virtualenv_path }}"
      recurse: yes
      owner: "{{ system_user }}"
      group: "{{ system_group }}"
      mode: u=rwX,g=rw,o=rw

- include: install_requirements.yml
  tags: deploy

- include: setup_django_app.yml
  notify: touch reload
  tags: deploy

